/**
 * NOTICE:
 * This file is generated and managed programmatically by Innate.
 * Do not edit this file directly. Edits to this file will be overwritten.
 */

import { createYoga } from 'graphql-yoga'
import { PrismaClient } from '@prisma/client'
import { stdout } from '../../../utils/cli/debug'
import type { Context } from '../../../../codegen/api/types/Context'
import { baseYogaProps } from '../../../api/shared/server/baseYogaProps'

export async function startServer({ debug }: { debug: number }) {
  const portArg = Bun.argv.findIndex((arg) => arg === '--port')
  const port = Bun.argv[portArg + 1]

  const prisma = new PrismaClient()

  const yoga = createYoga<{}, Context>({
    graphiql: true,
    schema: downstreamSchema,
    ...baseYogaProps({ prisma, debug }),
  })

  const server = Bun.serve(
    instantiateServer({
      serverInstance: yoga,
      config: {
        port,
        useTLS: true,
      },
    }),
  )

  stdout(
    `💁 Server for clients is listening at ${new URL(
      yoga.graphqlEndpoint,
      server.url,
    )}`,
  )
}
